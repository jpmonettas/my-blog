<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Debugging Compilers with FlowStorm</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="application/atom+xml" rel="alternate" href="atom.xml" title="Debugging Compilers with FlowStorm">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-clojure.min.js"></script>
    <script type="text/javascript" src="https://livejs.com/live.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism.min.css">



    <!-- Social sharing (Facebook, Twitter, LinkedIn, etc.) -->
    <meta name="title" content="Debugging Compilers with FlowStorm">
    <meta name="twitter:title" content="Debugging Compilers with FlowStorm">
    <meta property="og:title" content="Debugging Compilers with FlowStorm">
    <meta property="og:type" content="website">


    <meta name="twitter:url" content="https://github.com/borkdude/quickblog/test.html">
    <meta property="og:url" content="https://github.com/borkdude/quickblog/test.html">


    <meta name="twitter:card" content="summary">



  </head>
  <body>

    <div class="site-header">
      <div class="wrapper">
        <div class="site-nav">
          <a class="page-link" href="archive.html">Archive</a>
          <a class="page-link" href="tags/index.html">Tags</a>
          <a class="page-link" href="">Discuss</a>
	  <a class="page-link" href="atom.xml">
            Feed
          </a>
	  
	  
        </div>
        <div>
          <h1 class="site-title">
            <a class="page-link" href="index.html">A bi1 0f fun</a>
          </h1>
	  <p>A blog Clojure, interactive programming, dev tooling and more...</p>
        </div>
      </div>
    </div>

    <div class="wrapper">

      <h1>
  
  Debugging Compilers with FlowStorm
  
</h1>
<p>This is (I hope) part of a series of blog posts with some ideas on using FlowStorm, a Clojure omniscient and time travel debugger, to help us reason about our Clojure systems.</p><h1>Before starting</h1><p>This whole post is designed so you can follow along by copying the commands on your terminal, and will not depend on any particular  IDE or special tooling appart from FlowStorm.</p><p>If you haven't seen it before, we call FlowStorm a debugger, since a lot of its features like code stepping, are those found on debuggers, but this could be a little too constraning, since I think it can be used for much more than chasing bugs.</p><p>FlowStorm was designed as a tool for visualizing what is happening inside our Clojure programs as they run, and specially designed  with interactive programming and immutability in mind.</p><p>Before starting, for people new to Clojure and Lisps in general, interactive programming is about developing a system by interacting with a running process, in contrast with the more traditional way of : modify your files, re-compile everything, run the process, stop it, rinse and repeat. Immutability is about your programs dealing mostly with immutable values insted of references to mutable places in memory.</p><p>Interactivity and immutability alone are already quite powerful when trying to understand a system, given you can poke at it by call different functions, inspect the data, modify and recompile specific functions all without losing your application state or having to deal with long time compilation times.</p><p>Poking at systems via function calling, println (or the more modern tap>), scope capturing, single stepping etc are great tools when you know most of the system and you are confident that looking at specific points of your systems execution will be enough to reveal the answers of your questions.</p><p>The FlowStorm approach is to provide an easy way of recording and visualizing your programs execution when you need it.</p><p>This post will be using as an example, the "debugging" of the ClojureScript compiler, which is written in Clojure and compiles ClojureScript code into JavaScript. I've choosen it for demoing the techniques since it is a well known, non trivial, Clojure applicaiton, but all the techniques demoed here should apply to any Clojure application.</p><p>Following this post doesn't require any particular knowledge on compilers. The ClojureScript compiler can be seen as a system that will take a string representing Clojure code form, parses it into a tree of expressions also known as the AST (abstract syntax tree) which in this case is a nested Clojure maps structure, and then walks down the tree emitting  strings containing JavaScript code. You can think of it like :</p><pre><code class="lang-clojure">&#40;-&gt; code-string
    &#40;read&#41;
    &#40;parse-into-ast&#41;
    &#40;emit-js&#41;&#41;
</code></pre><p>which is of course an over simplificaiton but should be enough for following the blog post.</p><h1>Setting up</h1><p>For working with the ClojureScript compiler we first need its sources, so lets start by clonning the repo :</p><pre><code class="lang-bash">$ git clone https://github.com/clojure/clojurescript
$ cd clojurescript
</code></pre><p>Now we can setup FlowStorm by modifying the project <code>deps.edn</code> file like this :<pre><code class="lang-clojure">{... 
 :aliases
 {...
  :storm
  {:classpath-overrides {org.clojure/clojure nil} ;; for disabling the official compiler
   :extra-deps {com.github.flow-storm/clojure {:mvn/version &quot;1.11.1-11&quot;}
                com.github.flow-storm/flow-storm-dbg {:mvn/version &quot;3.8.1&quot;}}
   :jvm-opts &#91;&quot;-Dclojure.storm.instrumentEnable=true&quot;
              &quot;-Dclojure.storm.instrumentOnlyPrefixes=cljs&quot;
              &quot;-Dflowstorm.startRecording=false&quot;
              &quot;-Dclojure.server.repl={:port 5555 :accept clojure.core.server/repl}&quot;&#93;}}}

</code></pre></p><p>So there is quite a lot going on there but luckly we only need to do this once. We added a new alias <code>:storm</code> so we can easily start a repl with everything we need.  The important parts there are :</p><ul><li>disabling the official Clojure compiler, since we are going to swap it by ClojureStorm our dev compiler</li><li>adding FlowStorm and ClojureStorm dependencies</li><li>telling ClojureStorm that we want instrumentation enable, to instrument all namespaces under <code>cljs.&#42;</code>, and that recording should be disabled at startup</li><li>we also start a socket repl, so we can have two terminals, one with a ClojureScript repl and one with a Clojure one  </li></ul><p>Now we can finally run a Clojure repl with the <code>:storm</code> alias :</p><pre><code class="lang-bash">$ clj -A:storm

user=&gt; :dbg
user=&gt; &#40;require 'cljs.main&#41;
user=&gt; &#40;cljs.main/-main &quot;--repl&quot;&#41;

ClojureScript 0.0.249695361
cljs.user=&gt;
</code></pre><p>Then, the first thing we do is to start the FlowStorm GUI, which we do by evaluating the <code>:dbg</code> key in this ClojureStorm repl. Immediately after it, we require the main ClojureScript compiler namespace and run the main function with the <code>--repl</code> arg which tells ClojureScript to start a browser repl. For people new to Clojure, the ClojureScript compiler is just a Clojure function we can invoke from our Clojure repl.</p><p>This should have opened a browser window and converted our Clojure repl into a ClojureScript one.</p><p>Everything you type there will be read, compiled into JavaScript and sent to the browser for execution.</p><p>Finally we will connect another Clojure repl to the same process our compiler is running by just connecting with telnet to the socket repl we defined earlier.</p><pre><code class="lang-bash">telnet 127.0.0.1 5555

user=&gt;
</code></pre><p>And that is it, at this point we should have :     </p><ul><li>a terminal with a Clojure repl</li><li>a terminal with a ClojureScript repl</li><li>the FlowStorm UI  </li></ul><h1>FlowStorm UI basics</h1><p><img src="assets/compilers-with-flow-storm/flow-storm-ui.png"></p><p>Main ui description before recording</p><p>Start recording</p><p>Evaluating a simple funciton like (defn sum [a b] (+ a b))</p><p>Stop recording</p><p><img src="assets/compilers-with-flow-storm/flow-storm-ui-after-recording.png"></p><p>Main ui description after recording</p><p>Clearing the recordings</p><h1>Understanding parsing</h1><p>We are not going to focus much on the reader because it is (read)</p>
<p>Discuss this post <a href="">here</a>.</p>
<p><i>Published: 2023-10-19</i></p>

<p>
  <i>
  Tagged:
  
  <span class="tag">
    <a href="tags/clojure.html">clojure</a>
  </span>
  
  </i>
</p>



      
      <div style="margin-bottom: 20px; float: right;">
        <a class="page-link" href="archive.html">Archive</a>
      </div>
      
    </div>
  </body>
</html>
